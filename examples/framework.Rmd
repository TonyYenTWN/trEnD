```{r setup, include = FALSE}
library("rstudioapi")
library(plotly)
library(rgdal)
library(rgeos)
library(fields)

parent_dir = dirname(getwd())
setwd(parent_dir)

### Plot canvas for maps
dir_name <- paste(getwd(), "/data/input/", sep = "")
file_name <- "NO_10k/NO_10k.shp"
map_data <- readOGR(paste(dir_name, file_name, sep = ""))
norway_map_union <- gUnaryUnion(map_data)

file_name <- "transmission_nodes.csv"
node_data <- read.csv(paste(dir_name, file_name, sep = ""), sep = ",")

fractal_power <- 2
margin <- 18000
x_min <- min(norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 1], node_data$x) - margin
y_min <- min(norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 2], node_data$y) - margin
x_max <- max(norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 1], node_data$x) + margin
y_max <- max(norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 2], node_data$y) + margin
x_range <- c(x_min, x_max)
y_range <- c(y_min, y_max)
w_plot <- 700
h_plot <- w_plot * diff(y_range) / diff(x_range)
NO_power_system_plot <- plot_ly(width = w_plot, height = h_plot, showlegend = FALSE) %>%
  add_trace(x = norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 1], 
  y = norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 2], 
  type = 'scatter', mode = 'lines', name = "Border", line = list(color = "black"), hoverinfo = 'none') %>%
  layout(xaxis = list(showgrid = F, automargin = FALSE, range = x_range, showline = FALSE, showticklabels = FALSE), 
  yaxis = list(showgrid = F, automargin = FALSE, range = y_range, showline = FALSE, showticklabels = FALSE),
  margin = list(b = 0, t = 0, l = 0, r = 0),
  font = list(family = "times new roman")
  )
NO_power_system_plot <- NO_power_system_plot %>%
  config(
    toImageButtonOptions = list(
      format = "svg",
      filename = "map_plot",
      width = w_plot,
      height = h_plot
    )
  )
```

<!-- title for toc -->
# Power Network

<!-- title for toc -->
## - Technical Parameters

Type | Transmission | Regional | Distribution MV
:---:|:---:|:---:|:---:
$V_{LL}$ ($\small \mathrm{kV}$) | $\geq 132$ | $66$ | $22$
$z$ ($\small \Omega \: \mathrm {km^{-1}}$) | $0.025 + j \:0.25$ | $0.12 + j \:0.4$ | $0.6 + j \:0.6$ 
$y_{sh}$ ($\small \Omega^{-1} \: \mathrm {km^{-1}}$) | $j \:2\times10^{-6}$ | $j \:4.5\times10^{-7}$ | $j \:1\times10^{-7}$
: Assumed values for technical parameters of power lines in the simulations. $V_{LL}$: line to line voltage; $z$: series impedance; $y_{sh}$: shunt admittance.

<!-- title for toc -->
## - Operational Constraints
There are 2 types of operational constraints in a power network: one arises from the technical parameters of the components, and the other arises from the dynamical properties of the system. Power flow limits on the lines is mainly caused by the former (due to line sag and tension) while the latter limits the phase angle and maximum allowed power supply / demand at a node (to avoid voltage collapse).

<!-- title for toc -->
## - Per Phase and Per Unit Conversion

<!-- title for toc -->
## - Geoinformation of Power Network {.tabset .tabset-fade .tabset-pills}

### Clustered
```{r clustered network, echo = FALSE, message = FALSE, warning = FALSE}
file_name <- "TSO_simplified_network.csv"
edge_data <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

### Plot
NO_power_system_plot_temp <- NO_power_system_plot
for(edge_iter in 1:nrow(edge_data)){
  x_coor <- c()
  y_coor <- c()
  
  x_coor[1] <- node_data$x[edge_data$from[edge_iter] + 1]
  x_coor[3] <- node_data$x[edge_data$to[edge_iter] + 1]
  x_coor[2] <- .5 * (x_coor[1] + x_coor[3])
  y_coor[1] <- node_data$y[edge_data$from[edge_iter] + 1]
  y_coor[3] <- node_data$y[edge_data$to[edge_iter] + 1]
  y_coor[2] <- .5 * (y_coor[1] + y_coor[3])  
  
  NO_power_system_plot_temp <- NO_power_system_plot_temp %>%
    add_trace(x = x_coor, y = y_coor, 
    type = 'scatter', mode = 'lines',
    line = list(color = "black"), 
    # opacity = edge_average_flow[edge_iter]^(1 / fractal_power),
    name = paste("edge ", edge_iter, sep = ""),
    text = paste("edge ", edge_iter, sep = ""),
    hoverinfo = 'text'
    )
}

for(node_iter in 1:nrow(node_data)){
  NO_power_system_plot_temp <- NO_power_system_plot_temp %>%
    add_trace(x = node_data$x[node_iter], y = node_data$y[node_iter],
    type = 'scatter', mode = 'markers',
    marker = list(color = "black", size = 10),
    name = paste("node ", node_iter, sep = ""),
    text = paste("node ", node_iter, "\nlon: ", round(node_data$lon[node_iter], 3), "째", 
                 "\nlat: ", round(node_data$lat[node_iter], 3), "째", sep = ""),
    hoverinfo = 'text'    
    )
}

NO_power_system_plot_temp
```

### Original

<!-- title for toc -->
# Power Market

<!-- title for toc -->
# Agents

<!-- title for toc -->
## - Population Density
```{r population density, echo = FALSE, message = FALSE, warning = FALSE}
file_name <- "point_info.csv"
point_data <- read.csv(paste(dir_name, file_name, sep = ""), sep = ",")

file_name <- "point_matrix.csv"
point_matrix <- read.csv(paste(dir_name, file_name, sep = ""), sep = ",")

pop_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(pop_Mat)){
  for(col_iter in 1:ncol(pop_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      pop_Mat[row_iter, col_iter] <- NA
    }else{
      pop_Mat[row_iter, col_iter] <- point_data$pop_density[point_matrix[row_iter, col_iter]]
    }
  }
}
pop_Mat <- t(pop_Mat)

### Parameters for the field
library(RColorBrewer)
x_range_field <- range(point_data$x)
y_range_field  <- range(point_data$y)
res_field  <- 10000

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = log(pop_Mat), type = "heatmap",
  hoverinfo = 'none',
  coloraxis = "coloraxis") %>% 
  layout(coloraxis = list(colorscale='YlOrRd', reversescale = T, showscale = F))

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "째",
               "\nlat: ", round(point_data$lat, 3), "째",
               "\n\npopulation density:\n", round(point_data$pop_density, 3),
               " ppl / km^2", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Population Density (ppl / km^2):", textposition = "top right", hoverinfo = 'none')
palette <- brewer.pal(9,'YlOrRd')[c(1, 3, 6, 8, 9)]
pop_level <- round(max(pop_Mat, na.rm = T)^(c(1 / 9, 1/ 3, 2 / 3, 8 / 9, 1)) * min(pop_Mat, na.rm = T)^(1 - c(1 / 9, 1/ 3, 2 / 3, 8 / 9, 1)), 1)
for(level_iter in 1:length(pop_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = pop_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot
```