```{r setup, include = FALSE}
library("rstudioapi")
library(plotly)
library(rgdal)
library(rgeos)
library(reldist)
library(knitr)

##################################################################################

Time <- 336

# Set time name
year <- 2021
days_of_month <- c(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31)
hours <- c()
count <- 0
for(month_iter in 1:12){
  if(month_iter < 10){
    month_name <- paste(0, month_iter, sep = "")
  }else{
    month_name <- month_iter
  }
  
  
  for(day_iter in 1:days_of_month[month_iter]){
    if(day_iter < 10){
      day_name <- paste(0, day_iter, sep = "")
    }else{
      day_name <- day_iter
    }
    
    for(hour_iter in 0:23){
      count <- count + 1
      
      if(hour_iter < 10){
        hour_name <- paste(0, hour_iter, sep = "")
      }else{
        hour_name <- hour_iter
      }
      
      hours[count] <- paste(year, "-", month_name, "-", day_name, " ", hour_name, ":00", sep = "")
    }
  }
}

timestamp_01 <- hours[1:Time]
timestamp_02 <- hours[4344 + 1:Time]

##################################################################################

parent_dir = dirname(getwd())
setwd(parent_dir)

### Plot canvas for maps
dir_name <- paste(getwd(), "/data/input/", sep = "")
file_name <- "NO_10k/NO_10k.shp"
map_data <- readOGR(paste(dir_name, file_name, sep = ""))
norway_map_union <- gUnaryUnion(map_data)

file_name <- "transmission_nodes.csv"
node_data <- read.csv(paste(dir_name, file_name, sep = ""), sep = ",")

file_name <- "DSO_Bidding_Zone.csv"
DSO_data <- read.csv(paste(dir_name, file_name, sep = ""), sep = ",")

fractal_power <- 2
margin <- 18000
x_min <- min(norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 1], node_data$x) - margin
y_min <- min(norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 2], node_data$y) - margin
x_max <- max(norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 1], node_data$x) + margin
y_max <- max(norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 2], node_data$y) + margin
x_range <- c(x_min, x_max)
y_range <- c(y_min, y_max)
w_plot_map <- 700
h_plot_map <- w_plot_map * diff(y_range) / diff(x_range)
NO_power_system_plot <- plot_ly(width = w_plot_map, height = h_plot_map, showlegend = FALSE) %>%
  add_trace(x = norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 1], 
  y = norway_map_union@polygons[[1]]@Polygons[[1]]@coords[, 2], 
  type = 'scatter', mode = 'lines', name = "Border", line = list(color = "black"), hoverinfo = 'none') %>%
  layout(xaxis = list(showgrid = F, automargin = FALSE, range = x_range, showline = FALSE, showticklabels = FALSE), 
  yaxis = list(showgrid = F, automargin = FALSE, range = y_range, showline = FALSE, showticklabels = FALSE),
  margin = list(b = 0, t = 0, l = 0, r = 0),
  font = list(family = "times new roman")
  )
NO_power_system_plot <- NO_power_system_plot %>%
  config(
    toImageButtonOptions = list(
      format = "svg",
      filename = "map_plot",
      width = w_plot_map,
      height = h_plot_map
    )
  )

### Plot canvas for boxplots
box_plot <- plot_ly(type = 'box') %>%
  layout(showlegend = T, 
  legend = list(orientation = 'h', x = 0.4, y = -0.15),
  boxmode = "group",
  xaxis = list(rangeslider = list(visible = F), showgrid = F, showline = T, title = "Bidding Zone"),
  yaxis = list(showgrid = F, showline = T, title = "Average Electricity Price (EUR / MWh)"),
  font = list(family = "times new roman")
  )
box_plot <- box_plot %>%
  config(
    toImageButtonOptions = list(
      format = "svg",
      filename = "price_plot"
    )
  )


##################################################################################

### Parameters for the field
library(RColorBrewer)

file_name <- "point_info.csv"
point_data <- read.csv(paste(dir_name, file_name, sep = ""), sep = ",")

file_name <- "point_matrix.csv"
point_matrix <- read.csv(paste(dir_name, file_name, sep = ""), sep = ",")

x_range_field <- range(point_data$x)
y_range_field  <- range(point_data$y)
res_field  <- 10000

bidding_zone_points <- list()
bidding_zone_points[6] <- c()
for(point_iter in 1:nrow(point_data)){
  bz_ID <- DSO_data$Bidding_Zone[point_data$DSO[point_iter]]
  bidding_zone_points[[bz_ID]] <- c(bidding_zone_points[[bz_ID]], point_iter)
}

##################################################################################

file_name <- "end_user_types_ref.csv"
end_user_types_ref <- read.csv(paste(dir_name, file_name, sep = ""), sep = ",")

file_name <- "end_user_types_active.csv"
end_user_types_active <- read.csv(paste(dir_name, file_name, sep = ""), sep = ",")

##################################################################################

reference_gain <- c(Inf, -Inf)
bat_eff <- .95
wtp_user <- 3000

```

<!-- title for toc -->
# Average Electricity Price Reduction Per Capita

<!-- title for toc -->
## - Reference 1 {.tabset .tabset-fade .tabset-pills}

### January
```{r price reduction jan ref 01, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_01"
time_name <- "0101-0114"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

price_0 <- end_user_type_0$EOM_price
price_0 <- price_0 + end_user_type_0$redispatch_price
price_0 <- price_0 / (end_user_type_0$EOM_demand + end_user_type_0$redispatch_demand_up - end_user_type_0$redispatch_demand_down)

surplus_supply_2 <- end_user_type_2$BESS_supply - (end_user_type_2$EOM_supply + end_user_type_2$redispatch_supply_up - end_user_type_2$redispatch_supply_down)
price_2 <- end_user_type_2$EOM_price
price_2 <- price_2 + end_user_type_2$redispatch_price
price_2 <- price_2 / (end_user_type_2$EOM_demand + end_user_type_2$redispatch_demand_up - end_user_type_2$redispatch_demand_down + surplus_supply_2)

average_diff <- c()
medium_weighted_prices <- matrix(nrow = length(bidding_zone_points), ncol = 2)
rownames(medium_weighted_prices) <- paste("Bidding Zones ", c(1:5), sep = "")
colnames(medium_weighted_prices) <- c("Inflexible", "Flexible Ordinary")
medium_prices <- matrix(nrow = length(bidding_zone_points), ncol = 2)
for(bz_iter in 1:length(bidding_zone_points)){
  average_diff[bz_iter] <- sum((price_0[bidding_zone_points[[bz_iter]]] - price_2[bidding_zone_points[[bz_iter]]]) * point_data$pop_density[bidding_zone_points[[bz_iter]]]) / sum(point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 1] <- wtd.quantile(price_0[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 2] <- wtd.quantile(price_2[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 1] <- median(price_0[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 2] <- median(price_2[bidding_zone_points[[bz_iter]]])
}
kable(round(medium_weighted_prices, 3), caption = "Weighted median average electricity prices", align = "cccc")
average_total_0 <- sum(price_0 * point_data$pop_density) / sum(point_data$pop_density)

box_plot_temp <- box_plot
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_0, name = "Inflexible")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_2, name = "Flexible")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_0, xaxis='x2', yaxis='y2', name = "Inflexible", showlegend = F)
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_2, xaxis='x2', yaxis='y2', name = "Flexible", showlegend = F)
box_plot_temp <- box_plot_temp %>% 
  layout(xaxis2 = list(domain = c(0.6, 1), anchor='y2', rangeslider = list(visible = F), showgrid = F, showline = T, title = "", showticklabels = FALSE),
         yaxis2 = list(domain = c(0.6, 1), anchor='x2', showgrid = F, showline = T, title = "", range = c(0, 500)))
box_plot_temp
```

### July
```{r price reduction jul ref 01, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_01"
time_name <- "0701-0714"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

price_0 <- end_user_type_0$EOM_price
price_0 <- price_0 + end_user_type_0$redispatch_price
price_0 <- price_0 / (end_user_type_0$EOM_demand + end_user_type_0$redispatch_demand_up - end_user_type_0$redispatch_demand_down)

surplus_supply_2 <- end_user_type_2$BESS_supply - (end_user_type_2$EOM_supply + end_user_type_2$redispatch_supply_up - end_user_type_2$redispatch_supply_down)
price_2 <- end_user_type_2$EOM_price
price_2 <- price_2 + end_user_type_2$redispatch_price
price_2 <- price_2 / (end_user_type_2$EOM_demand + end_user_type_2$redispatch_demand_up - end_user_type_2$redispatch_demand_down + surplus_supply_2)

average_diff <- c()
medium_weighted_prices <- matrix(nrow = length(bidding_zone_points), ncol = 2)
rownames(medium_weighted_prices) <- paste("Bidding Zones ", c(1:5), sep = "")
colnames(medium_weighted_prices) <- c("Inflexible", "Flexible Ordinary")
medium_prices <- matrix(nrow = length(bidding_zone_points), ncol = 2)
for(bz_iter in 1:length(bidding_zone_points)){
  average_diff[bz_iter] <- sum((price_0[bidding_zone_points[[bz_iter]]] - price_2[bidding_zone_points[[bz_iter]]]) * point_data$pop_density[bidding_zone_points[[bz_iter]]]) / sum(point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 1] <- wtd.quantile(price_0[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 2] <- wtd.quantile(price_2[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 1] <- median(price_0[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 2] <- median(price_2[bidding_zone_points[[bz_iter]]])
}
kable(round(medium_weighted_prices, 3), caption = "Weighted median average electricity prices", align = "cccc")
average_total_0 <- sum(price_0 * point_data$pop_density) / sum(point_data$pop_density)

box_plot_temp <- box_plot
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_0, name = "Inflexible")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_2, name = "Flexible")
box_plot_temp

```

## - Reference 2 {.tabset .tabset-fade .tabset-pills}

### January
```{r price reduction jan ref 02, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_02"
time_name <- "0101-0114"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

price_0 <- end_user_type_0$EOM_price
price_0 <- price_0 + end_user_type_0$redispatch_price
price_0 <- price_0 / (end_user_type_0$EOM_demand + end_user_type_0$redispatch_demand_up - end_user_type_0$redispatch_demand_down)

surplus_supply_2 <- end_user_type_2$BESS_supply - (end_user_type_2$EOM_supply + end_user_type_2$redispatch_supply_up - end_user_type_2$redispatch_supply_down)
price_2 <- end_user_type_2$EOM_price
price_2 <- price_2 + end_user_type_2$redispatch_price
price_2 <- price_2 / (end_user_type_2$EOM_demand + end_user_type_2$redispatch_demand_up - end_user_type_2$redispatch_demand_down + surplus_supply_2)

average_diff <- c()
medium_weighted_prices <- matrix(nrow = length(bidding_zone_points), ncol = 2)
rownames(medium_weighted_prices) <- paste("Bidding Zones ", c(1:5), sep = "")
colnames(medium_weighted_prices) <- c("Inflexible", "Flexible Ordinary")
medium_prices <- matrix(nrow = length(bidding_zone_points), ncol = 2)
for(bz_iter in 1:length(bidding_zone_points)){
  average_diff[bz_iter] <- sum((price_0[bidding_zone_points[[bz_iter]]] - price_2[bidding_zone_points[[bz_iter]]]) * point_data$pop_density[bidding_zone_points[[bz_iter]]]) / sum(point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 1] <- wtd.quantile(price_0[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 2] <- wtd.quantile(price_2[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 1] <- median(price_0[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 2] <- median(price_2[bidding_zone_points[[bz_iter]]])
}
kable(round(medium_weighted_prices, 3), caption = "Weighted median average electricity prices", align = "cccc")
average_total_0 <- sum(price_0 * point_data$pop_density) / sum(point_data$pop_density)

box_plot_temp <- box_plot
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_0, name = "Inflexible")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_2, name = "Flexible")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_0, xaxis='x2', yaxis='y2', name = "Inflexible", showlegend = F)
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_2, xaxis='x2', yaxis='y2', name = "Flexible", showlegend = F)
box_plot_temp <- box_plot_temp %>% 
  layout(xaxis2 = list(domain = c(0.6, 1), anchor='y2', rangeslider = list(visible = F), showgrid = F, showline = T, title = "", showticklabels = FALSE),
         yaxis2 = list(domain = c(0.6, 1), anchor='x2', showgrid = F, showline = T, title = "", range = c(0, 500)))
box_plot_temp
```

### July
```{r price reduction jul ref 02, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_02"
time_name <- "0701-0714"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

price_0 <- end_user_type_0$EOM_price
price_0 <- price_0 + end_user_type_0$redispatch_price
price_0 <- price_0 / (end_user_type_0$EOM_demand + end_user_type_0$redispatch_demand_up - end_user_type_0$redispatch_demand_down)

surplus_supply_2 <- end_user_type_2$BESS_supply - (end_user_type_2$EOM_supply + end_user_type_2$redispatch_supply_up - end_user_type_2$redispatch_supply_down)
price_2 <- end_user_type_2$EOM_price
price_2 <- price_2 + end_user_type_2$redispatch_price
price_2 <- price_2 / (end_user_type_2$EOM_demand + end_user_type_2$redispatch_demand_up - end_user_type_2$redispatch_demand_down + surplus_supply_2)

average_diff <- c()
medium_weighted_prices <- matrix(nrow = length(bidding_zone_points), ncol = 2)
rownames(medium_weighted_prices) <- paste("Bidding Zones ", c(1:5), sep = "")
colnames(medium_weighted_prices) <- c("Inflexible", "Flexible Ordinary")
medium_prices <- matrix(nrow = length(bidding_zone_points), ncol = 2)
for(bz_iter in 1:length(bidding_zone_points)){
  average_diff[bz_iter] <- sum((price_0[bidding_zone_points[[bz_iter]]] - price_2[bidding_zone_points[[bz_iter]]]) * point_data$pop_density[bidding_zone_points[[bz_iter]]]) / sum(point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 1] <- wtd.quantile(price_0[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 2] <- wtd.quantile(price_2[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 1] <- median(price_0[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 2] <- median(price_2[bidding_zone_points[[bz_iter]]])
}
kable(round(medium_weighted_prices, 3), caption = "Weighted median average electricity prices", align = "cccc")
average_total_0 <- sum(price_0 * point_data$pop_density) / sum(point_data$pop_density)

box_plot_temp <- box_plot
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_0, name = "Inflexible")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_2, name = "Flexible")
box_plot_temp

```

## Active End-users {.tabset .tabset-fade .tabset-pills}

### January
```{r price reduction jan active, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "active_end_user"
time_name <- "0101-0114"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_3.csv"
end_user_type_3 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

price_0 <- end_user_type_0$EOM_price
price_0 <- price_0 + end_user_type_0$redispatch_price
price_0 <- price_0 / (end_user_type_0$EOM_demand + end_user_type_0$redispatch_demand_up - end_user_type_0$redispatch_demand_down)

surplus_supply_2 <- end_user_type_2$BESS_supply - (end_user_type_2$EOM_supply + end_user_type_2$redispatch_supply_up - end_user_type_2$redispatch_supply_down)
price_2 <- end_user_type_2$EOM_price
price_2 <- price_2 + end_user_type_2$redispatch_price
price_2 <- price_2 / (end_user_type_2$EOM_demand + end_user_type_2$redispatch_demand_up - end_user_type_2$redispatch_demand_down + surplus_supply_2)

surplus_supply_3 <- end_user_type_3$BESS_supply - (end_user_type_3$EOM_supply + end_user_type_3$redispatch_supply_up - end_user_type_3$redispatch_supply_down)
price_3 <- end_user_type_3$EOM_price
price_3 <- price_3 + end_user_type_3$redispatch_price - end_user_type_3$redispatch_reimbursement
price_3 <- price_3 / (end_user_type_3$EOM_demand + end_user_type_3$redispatch_demand_up - end_user_type_3$redispatch_demand_down + surplus_supply_3)

average_diff <- c()
medium_weighted_prices <- matrix(nrow = length(bidding_zone_points), ncol = 3)
rownames(medium_weighted_prices) <- paste("Bidding Zones ", c(1:5), sep = "")
colnames(medium_weighted_prices) <- c("Inflexible", "Flexible Ordinary", "Flexible Active")
medium_prices <- matrix(nrow = length(bidding_zone_points), ncol = 3)
for(bz_iter in 1:length(bidding_zone_points)){
  average_diff[bz_iter] <- sum((price_0[bidding_zone_points[[bz_iter]]] - price_2[bidding_zone_points[[bz_iter]]]) * point_data$pop_density[bidding_zone_points[[bz_iter]]]) / sum(point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 1] <- wtd.quantile(price_0[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 2] <- wtd.quantile(price_2[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 3] <- wtd.quantile(price_3[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]]) 
  medium_prices[bz_iter, 1] <- median(price_0[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 2] <- median(price_2[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 3] <- median(price_3[bidding_zone_points[[bz_iter]]])    
}
kable(round(medium_weighted_prices, 3), caption = "Weighted median average electricity prices", align = "cccc")
average_total_0 <- sum(price_0 * point_data$pop_density) / sum(point_data$pop_density)

box_plot_temp <- box_plot
box_plot_temp <- box_plot_temp %>%
  layout(showlegend = T, 
  legend = list(orientation = 'h', x = 0.25, y = -0.15)
  )
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_0, name = "Inflexible")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_2, name = "Flexible Ordinary")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_3, name = "Flexible Active")
box_plot_temp
```

### July
```{r price reduction jul active, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "active_end_user"
time_name <- "0701-0714"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_3.csv"
end_user_type_3 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

price_0 <- end_user_type_0$EOM_price
price_0 <- price_0 + end_user_type_0$redispatch_price
price_0 <- price_0 / (end_user_type_0$EOM_demand + end_user_type_0$redispatch_demand_up - end_user_type_0$redispatch_demand_down)

surplus_supply_2 <- end_user_type_2$BESS_supply - (end_user_type_2$EOM_supply + end_user_type_2$redispatch_supply_up - end_user_type_2$redispatch_supply_down)
price_2 <- end_user_type_2$EOM_price
price_2 <- price_2 + end_user_type_2$redispatch_price
price_2 <- price_2 / (end_user_type_2$EOM_demand + end_user_type_2$redispatch_demand_up - end_user_type_2$redispatch_demand_down + surplus_supply_2)

surplus_supply_3 <- end_user_type_3$BESS_supply - (end_user_type_3$EOM_supply + end_user_type_3$redispatch_supply_up - end_user_type_3$redispatch_supply_down)
price_3 <- end_user_type_3$EOM_price
price_3 <- price_3 + end_user_type_3$redispatch_price - end_user_type_3$redispatch_reimbursement
price_3 <- price_3 / (end_user_type_3$EOM_demand + end_user_type_3$redispatch_demand_up - end_user_type_3$redispatch_demand_down + surplus_supply_3)

average_diff <- c()
medium_weighted_prices <- matrix(nrow = length(bidding_zone_points), ncol = 3)
rownames(medium_weighted_prices) <- paste("Bidding Zones ", c(1:5), sep = "")
colnames(medium_weighted_prices) <- c("Inflexible", "Flexible Ordinary", "Flexible Active")
medium_prices <- matrix(nrow = length(bidding_zone_points), ncol = 3)
for(bz_iter in 1:length(bidding_zone_points)){
  average_diff[bz_iter] <- sum((price_0[bidding_zone_points[[bz_iter]]] - price_2[bidding_zone_points[[bz_iter]]]) * point_data$pop_density[bidding_zone_points[[bz_iter]]]) / sum(point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 1] <- wtd.quantile(price_0[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 2] <- wtd.quantile(price_2[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]])
  medium_weighted_prices[bz_iter, 3] <- wtd.quantile(price_3[bidding_zone_points[[bz_iter]]], weight =  point_data$pop_density[bidding_zone_points[[bz_iter]]]) 
  medium_prices[bz_iter, 1] <- median(price_0[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 2] <- median(price_2[bidding_zone_points[[bz_iter]]])
  medium_prices[bz_iter, 3] <- median(price_3[bidding_zone_points[[bz_iter]]])    
}
kable(round(medium_weighted_prices, 3), caption = "Weighted median average electricity prices", align = "cccc")
average_total_0 <- sum(price_0 * point_data$pop_density) / sum(point_data$pop_density)

box_plot_temp <- box_plot
box_plot_temp <- box_plot_temp %>%
  layout(showlegend = T, 
  legend = list(orientation = 'h', x = 0.25, y = -0.15)
  )
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_0, name = "Inflexible")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_2, name = "Flexible Ordinary")
box_plot_temp <- box_plot_temp %>% add_trace(x = DSO_data$Bidding_Zone[point_data$DSO], y = price_3, name = "Flexible Active")
box_plot_temp
```

<!-- title for toc -->
# Cost Reduction Per Capita

<!-- title for toc -->
## - Active Flexible vs Inflexible {.tabset .tabset-fade .tabset-pills}

### Reference 1 {.tabset .tabset-fade .tabset-pills}

#### January 
```{r cost reduction jan, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_01"
time_name <- "0101-0114"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

cost_0 <- end_user_type_0$EOM_cost + end_user_type_0$EOM_price
cost_0 <- cost_0 + end_user_type_0$redispatch_price
# cost_0 <- cost_0 + end_user_type_0$balancing_price
cost_0 <- cost_0 / point_data$pop_density / 100 / end_user_types_ref$X0[1]

cost_2 <- end_user_type_2$EOM_cost + end_user_type_2$EOM_price
cost_2 <- cost_2 + end_user_type_2$redispatch_price
# cost_2 <- cost_2 + end_user_type_2$balancing_price
cost_2 <- cost_2 / point_data$pop_density / 100 / end_user_types_ref$X2[1]

cost_diff <- cost_0 - cost_2

cost_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(cost_Mat)){
  for(col_iter in 1:ncol(cost_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      cost_Mat[row_iter, col_iter] <- NA
    }else{
      cost_Mat[row_iter, col_iter] <- cost_diff[point_matrix[row_iter, col_iter]]
    }
  }
}
cost_Mat <- t(cost_Mat)

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = (cost_Mat - min(cost_diff))^(1/1), type = "heatmap",
  hoverinfo = 'none',
  coloraxis = "coloraxis") %>% 
  layout(coloraxis = list(colorscale='YlOrRd', reversescale = T, showscale = F))

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "°",
               "\nlat: ", round(point_data$lat, 3), "°",
               "\n\ncost reduction:\n", round(cost_diff, 3),
               " EUR", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Cost reduction (EUR):", textposition = "top right", hoverinfo = 'none')
palette <- brewer.pal(9,'YlOrRd')[c(1, 3, 6, 8, 9)]
cost_level <- round(min(cost_Mat, na.rm = T) + diff(range(cost_Mat, na.rm = T)) * c(1 / 9, 1/ 3, 2 / 3, 8 / 9, 1)^1, 1)
for(level_iter in 1:length(cost_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = cost_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot

```

#### July
```{r cost reduction jul, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_01"
time_name <- "0701-0714"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

cost_0 <- end_user_type_0$EOM_cost + end_user_type_0$EOM_price
cost_0 <- cost_0 + end_user_type_0$redispatch_price
# cost_0 <- cost_0 + end_user_type_0$balancing_price
cost_0 <- cost_0 / point_data$pop_density / 100 / end_user_types_ref$X0[1]

cost_2 <- end_user_type_2$EOM_cost + end_user_type_2$EOM_price
cost_2 <- cost_2 + end_user_type_2$redispatch_price
# cost_2 <- cost_2 + end_user_type_2$balancing_price
cost_2 <- cost_2 / point_data$pop_density / 100 / end_user_types_ref$X2[1]

cost_diff <- cost_0 - cost_2

cost_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(cost_Mat)){
  for(col_iter in 1:ncol(cost_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      cost_Mat[row_iter, col_iter] <- NA
    }else{
      cost_Mat[row_iter, col_iter] <- cost_diff[point_matrix[row_iter, col_iter]]
    }
  }
}
cost_Mat <- t(cost_Mat)

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = (cost_Mat - min(cost_diff))^(1/1), type = "heatmap",
  hoverinfo = 'none',
  coloraxis = "coloraxis") %>% 
  layout(coloraxis = list(colorscale='YlOrRd', reversescale = T, showscale = F))

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "°",
               "\nlat: ", round(point_data$lat, 3), "°",
               "\n\ncost reduction:\n", round(cost_diff, 3),
               " EUR", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Cost reduction (EUR):", textposition = "top right", hoverinfo = 'none')
palette <- brewer.pal(9,'YlOrRd')[c(1, 3, 6, 8, 9)]
cost_level <- round(min(cost_Mat, na.rm = T) + diff(range(cost_Mat, na.rm = T)) * c(1 / 9, 1/ 3, 2 / 3, 8 / 9, 1)^1, 1)
for(level_iter in 1:length(cost_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = cost_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot

```

### Reference 2 {.tabset .tabset-fade .tabset-pills}

#### January 
```{r cost reduction jan ref 2, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_01"
time_name <- "0101-0114"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

cost_0 <- end_user_type_0$EOM_cost + end_user_type_0$EOM_price
cost_0 <- cost_0 + end_user_type_0$redispatch_price
# cost_0 <- cost_0 + end_user_type_0$balancing_price
cost_0 <- cost_0 / point_data$pop_density / 100 / end_user_types_ref$X0[1]

cost_2 <- end_user_type_2$EOM_cost + end_user_type_2$EOM_price
cost_2 <- cost_2 + end_user_type_2$redispatch_price
# cost_2 <- cost_2 + end_user_type_2$balancing_price
cost_2 <- cost_2 / point_data$pop_density / 100 / end_user_types_ref$X2[1]

cost_diff <- cost_0 - cost_2

cost_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(cost_Mat)){
  for(col_iter in 1:ncol(cost_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      cost_Mat[row_iter, col_iter] <- NA
    }else{
      cost_Mat[row_iter, col_iter] <- cost_diff[point_matrix[row_iter, col_iter]]
    }
  }
}
cost_Mat <- t(cost_Mat)

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = (cost_Mat - min(cost_diff))^(1/1), type = "heatmap",
  hoverinfo = 'none',
  coloraxis = "coloraxis") %>% 
  layout(coloraxis = list(colorscale='YlOrRd', reversescale = T, showscale = F))

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "°",
               "\nlat: ", round(point_data$lat, 3), "°",
               "\n\ncost reduction:\n", round(cost_diff, 3),
               " EUR", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Cost reduction (EUR):", textposition = "top right", hoverinfo = 'none')
palette <- brewer.pal(9,'YlOrRd')[c(1, 3, 6, 8, 9)]
cost_level <- round(min(cost_Mat, na.rm = T) + diff(range(cost_Mat, na.rm = T)) * c(1 / 9, 1/ 3, 2 / 3, 8 / 9, 1)^1, 1)
for(level_iter in 1:length(cost_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = cost_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot

```

<!-- title for toc -->
# Net Welfare Gain Per Capita

<!-- title for toc -->
## - Active Flexible vs Inflexible {.tabset .tabset-fade .tabset-pills}

### Reference 1 {.tabset .tabset-fade .tabset-pills}

#### January
```{r net welfare jan, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_01"
time_name <- "0101-0114"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

net_welfare_0 <- end_user_type_0$EOM_utility - end_user_type_0$EOM_cost - end_user_type_0$EOM_price
net_welfare_0 <- net_welfare_0 + end_user_type_0$redispatch_utility + end_user_type_0$redispatch_reimbursement - end_user_type_0$redispatch_cost - end_user_type_0$redispatch_price
# net_welfare_0 <- net_welfare_0 + end_user_type_0$balancing_utility + end_user_type_0$balancing_reimbursement - end_user_type_0$balancing_cost - end_user_type_0$balancing_price
net_welfare_0 <- net_welfare_0 / point_data$pop_density / 100 / end_user_types_ref$X0[1]

net_welfare_2 <- end_user_type_2$EOM_utility - end_user_type_2$EOM_cost - end_user_type_2$EOM_price
net_welfare_2 <- net_welfare_2 - end_user_type_2$EOM_supply / bat_eff^2 * wtp_user
net_welfare_2 <- net_welfare_2 + end_user_type_2$redispatch_utility + end_user_type_2$redispatch_reimbursement - end_user_type_2$redispatch_cost - end_user_type_2$redispatch_price
# net_welfare_2 <- net_welfare_2 + end_user_type_2$balancing_utility + end_user_type_2$balancing_reimbursement - end_user_type_2$balancing_cost - end_user_type_2$balancing_price
net_welfare_2 <- net_welfare_2 / point_data$pop_density / 100 / end_user_types_ref$X2[1]

net_welfare_diff <- net_welfare_2 - net_welfare_0

net_welfare_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(net_welfare_Mat)){
  for(col_iter in 1:ncol(net_welfare_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      net_welfare_Mat[row_iter, col_iter] <- NA
    }else{
      net_welfare_Mat[row_iter, col_iter] <- net_welfare_diff[point_matrix[row_iter, col_iter]]
    }
  }
}
net_welfare_Mat <- t(net_welfare_Mat)

### Parameters for the field
w_min <- min(min(range(net_welfare_Mat,na.rm = T)), reference_gain[1])
w_max <- max(max(range(net_welfare_Mat,na.rm = T)), reference_gain[2])
w_extend <- seq(w_min, w_max, length.out = 10000)
cols_extend <- scales::col_numeric("YlOrRd", domain = NULL)(w_extend)
start_ID <- round((min(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
end_ID <- round((max(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
w_vals <- w_extend[start_ID:end_ID]
w_vals_norm <- unique(scales::rescale(c(w_vals)))
cols <- cols_extend[start_ID:end_ID]
colz <- setNames(data.frame(w_vals_norm, cols), NULL)

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = (net_welfare_Mat - min(net_welfare_diff))^(1/1), type = "heatmap",
  hoverinfo = 'none',
  showscale = F,
  colorscale = colz)

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "°",
               "\nlat: ", round(point_data$lat, 3), "°",
               "\n\nnet welfare difference:\n", round(net_welfare_diff, 3),
               " EUR", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Net Welfare Gain (EUR):", textposition = "top right", hoverinfo = 'none')
palette_level <- cols_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))]
net_welfare_level <- round(w_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))], 3)
for(level_iter in 1:length(net_welfare_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette_level[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = net_welfare_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot
```

#### July
```{r net welfare jul, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_01"
time_name <- "0701-0714"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

# net_welfare_0 <- 0
# net_welfare_0 <- end_user_type_0$EOM_demand
net_welfare_0 <- end_user_type_0$EOM_utility - end_user_type_0$EOM_cost - end_user_type_0$EOM_price
net_welfare_0 <- net_welfare_0 + end_user_type_0$redispatch_utility + end_user_type_0$redispatch_reimbursement - end_user_type_0$redispatch_cost - end_user_type_0$redispatch_price
# net_welfare_0 <- net_welfare_0 + end_user_type_0$balancing_utility + end_user_type_0$balancing_reimbursement - end_user_type_0$balancing_cost - end_user_type_0$balancing_price
net_welfare_0 <- net_welfare_0 / point_data$pop_density / 100 / end_user_types_ref$X0[1]

# net_welfare_2 <- end_user_type_2$EOM_demand
net_welfare_2 <- end_user_type_2$EOM_utility - end_user_type_2$EOM_cost - end_user_type_2$EOM_price
net_welfare_2 <- net_welfare_2 - end_user_type_2$EOM_supply / bat_eff^2 * wtp_user
net_welfare_2 <- net_welfare_2 + end_user_type_2$redispatch_utility + end_user_type_2$redispatch_reimbursement - end_user_type_2$redispatch_cost - end_user_type_2$redispatch_price
# net_welfare_2 <- net_welfare_2 + end_user_type_2$balancing_utility + end_user_type_2$balancing_reimbursement - end_user_type_2$balancing_cost - end_user_type_2$balancing_price
net_welfare_2 <- net_welfare_2 / point_data$pop_density / 100 / end_user_types_ref$X2[1]

net_welfare_diff <- net_welfare_2 - net_welfare_0

net_welfare_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(net_welfare_Mat)){
  for(col_iter in 1:ncol(net_welfare_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      net_welfare_Mat[row_iter, col_iter] <- NA
    }else{
      net_welfare_Mat[row_iter, col_iter] <- net_welfare_diff[point_matrix[row_iter, col_iter]]
    }
  }
}
net_welfare_Mat <- t(net_welfare_Mat)

### Parameters for the field
w_min <- min(min(range(net_welfare_Mat,na.rm = T)), reference_gain[1])
w_max <- max(max(range(net_welfare_Mat,na.rm = T)), reference_gain[2])
w_extend <- seq(w_min, w_max, length.out = 10000)
cols_extend <- scales::col_numeric("YlOrRd", domain = NULL)(w_extend)
start_ID <- round((min(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
end_ID <- round((max(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
w_vals <- w_extend[start_ID:end_ID]
w_vals_norm <- unique(scales::rescale(c(w_vals)))
cols <- cols_extend[start_ID:end_ID]
colz <- setNames(data.frame(w_vals_norm, cols), NULL)

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = (net_welfare_Mat - min(net_welfare_diff))^(1/1), type = "heatmap",
  hoverinfo = 'none',
  showscale = F,
  colorscale = colz)

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "°",
               "\nlat: ", round(point_data$lat, 3), "°",
               "\n\nnet welfare difference:\n", round(net_welfare_diff, 3),
               " EUR", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Net Welfare Gain (EUR):", textposition = "top right", hoverinfo = 'none')
palette_level <- cols_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))]
net_welfare_level <- round(w_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))], 3)
for(level_iter in 1:length(net_welfare_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette_level[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = net_welfare_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot
```

### Reference 2 {.tabset .tabset-fade .tabset-pills}

#### January
```{r net welfare jan ref 2, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_02"
time_name <- "0101-0114"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

net_welfare_0 <- end_user_type_0$EOM_utility - end_user_type_0$EOM_cost - end_user_type_0$EOM_price
net_welfare_0 <- net_welfare_0 + end_user_type_0$redispatch_utility + end_user_type_0$redispatch_reimbursement - end_user_type_0$redispatch_cost - end_user_type_0$redispatch_price
# net_welfare_0 <- net_welfare_0 + end_user_type_0$balancing_utility + end_user_type_0$balancing_reimbursement - end_user_type_0$balancing_cost - end_user_type_0$balancing_price
net_welfare_0 <- net_welfare_0 / point_data$pop_density / 100 / end_user_types_ref$X0[1]

net_welfare_2 <- end_user_type_2$EOM_utility - end_user_type_2$EOM_cost - end_user_type_2$EOM_price
net_welfare_2 <- net_welfare_2 + end_user_type_2$redispatch_utility + end_user_type_2$redispatch_reimbursement - end_user_type_2$redispatch_cost - end_user_type_2$redispatch_price
# net_welfare_2 <- net_welfare_2 + end_user_type_2$balancing_utility + end_user_type_2$balancing_reimbursement - end_user_type_2$balancing_cost - end_user_type_2$balancing_price
net_welfare_2 <- net_welfare_2 / point_data$pop_density / 100 / end_user_types_ref$X2[1]

net_welfare_diff <- net_welfare_2 - net_welfare_0

net_welfare_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(net_welfare_Mat)){
  for(col_iter in 1:ncol(net_welfare_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      net_welfare_Mat[row_iter, col_iter] <- NA
    }else{
      net_welfare_Mat[row_iter, col_iter] <- net_welfare_diff[point_matrix[row_iter, col_iter]]
    }
  }
}
net_welfare_Mat <- t(net_welfare_Mat)

### Parameters for the field
w_min <- min(min(range(net_welfare_Mat,na.rm = T)), reference_gain[1])
w_max <- max(max(range(net_welfare_Mat,na.rm = T)), reference_gain[2])
w_extend <- seq(w_min, w_max, length.out = 10000)
cols_extend <- scales::col_numeric("YlOrRd", domain = NULL)(w_extend)
start_ID <- round((min(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
end_ID <- round((max(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
w_vals <- w_extend[start_ID:end_ID]
w_vals_norm <- unique(scales::rescale(c(w_vals)))
cols <- cols_extend[start_ID:end_ID]
colz <- setNames(data.frame(w_vals_norm, cols), NULL)

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = (net_welfare_Mat - min(net_welfare_diff))^(1/1), type = "heatmap",
  hoverinfo = 'none',
  showscale = F,
  colorscale = colz)

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "°",
               "\nlat: ", round(point_data$lat, 3), "°",
               "\n\nnet welfare difference:\n", round(net_welfare_diff, 3),
               " EUR", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Net Welfare Gain (EUR):", textposition = "top right", hoverinfo = 'none')
palette_level <- cols_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))]
net_welfare_level <- round(w_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))], 3)
for(level_iter in 1:length(net_welfare_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette_level[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = net_welfare_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot
```

#### July
```{r net welfare jul ref 2, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "ref_02"
time_name <- "0701-0714"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

net_welfare_0 <- end_user_type_0$EOM_utility - end_user_type_0$EOM_cost - end_user_type_0$EOM_price
net_welfare_0 <- net_welfare_0 + end_user_type_0$redispatch_utility + end_user_type_0$redispatch_reimbursement - end_user_type_0$redispatch_cost - end_user_type_0$redispatch_price
# net_welfare_0 <- net_welfare_0 + end_user_type_0$balancing_utility + end_user_type_0$balancing_reimbursement - end_user_type_0$balancing_cost - end_user_type_0$balancing_price
net_welfare_0 <- net_welfare_0 / point_data$pop_density / 100 / end_user_types_ref$X0[1]

net_welfare_2 <- end_user_type_2$EOM_utility - end_user_type_2$EOM_cost - end_user_type_2$EOM_price
net_welfare_2 <- net_welfare_2 + end_user_type_2$redispatch_utility + end_user_type_2$redispatch_reimbursement - end_user_type_2$redispatch_cost - end_user_type_2$redispatch_price
# net_welfare_2 <- net_welfare_2 + end_user_type_2$balancing_utility + end_user_type_2$balancing_reimbursement - end_user_type_2$balancing_cost - end_user_type_2$balancing_price
net_welfare_2 <- net_welfare_2 / point_data$pop_density / 100 / end_user_types_ref$X2[1]

net_welfare_diff <- net_welfare_2 - net_welfare_0

net_welfare_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(net_welfare_Mat)){
  for(col_iter in 1:ncol(net_welfare_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      net_welfare_Mat[row_iter, col_iter] <- NA
    }else{
      net_welfare_Mat[row_iter, col_iter] <- net_welfare_diff[point_matrix[row_iter, col_iter]]
    }
  }
}
net_welfare_Mat <- t(net_welfare_Mat)

### Parameters for the field
w_min <- min(min(range(net_welfare_Mat,na.rm = T)), reference_gain[1])
w_max <- max(max(range(net_welfare_Mat,na.rm = T)), reference_gain[2])
w_extend <- seq(w_min, w_max, length.out = 10000)
cols_extend <- scales::col_numeric("YlOrRd", domain = NULL)(w_extend)
start_ID <- round((min(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
end_ID <- round((max(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
w_vals <- w_extend[start_ID:end_ID]
w_vals_norm <- unique(scales::rescale(c(w_vals)))
cols <- cols_extend[start_ID:end_ID]
colz <- setNames(data.frame(w_vals_norm, cols), NULL)

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = (net_welfare_Mat - min(net_welfare_diff))^(1/1), type = "heatmap",
  hoverinfo = 'none',
  showscale = F,
  colorscale = colz)

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "°",
               "\nlat: ", round(point_data$lat, 3), "°",
               "\n\nnet welfare difference:\n", round(net_welfare_diff, 3),
               " EUR", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Net Welfare Gain (EUR):", textposition = "top right", hoverinfo = 'none')
palette_level <- cols_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))]
net_welfare_level <- round(w_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))], 3)
for(level_iter in 1:length(net_welfare_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette_level[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = net_welfare_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot
```


### Active End-users {.tabset .tabset-fade .tabset-pills}

#### January
```{r net welfare jan active, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "active_end_user"
time_name <- "0101-0114"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_3.csv"
end_user_type_3 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

net_welfare_0 <- end_user_type_0$EOM_utility - end_user_type_0$EOM_cost - end_user_type_0$EOM_price
net_welfare_0 <- net_welfare_0 + end_user_type_0$redispatch_utility + end_user_type_0$redispatch_reimbursement - end_user_type_0$redispatch_cost - end_user_type_0$redispatch_price
# net_welfare_0 <- net_welfare_0 + end_user_type_0$balancing_utility + end_user_type_0$balancing_reimbursement - end_user_type_0$balancing_cost - end_user_type_0$balancing_price
net_welfare_0 <- net_welfare_0 / point_data$pop_density / 100 / end_user_types_active$X0[1]

net_welfare_2 <- end_user_type_2$EOM_utility - end_user_type_2$EOM_cost - end_user_type_2$EOM_price
net_welfare_2 <- net_welfare_2 - end_user_type_2$EOM_supply / bat_eff^2 * wtp_user
net_welfare_2 <- net_welfare_2 + end_user_type_2$redispatch_utility + end_user_type_2$redispatch_reimbursement - end_user_type_2$redispatch_cost - end_user_type_2$redispatch_price
# net_welfare_2 <- net_welfare_2 + end_user_type_2$balancing_utility + end_user_type_2$balancing_reimbursement - end_user_type_2$balancing_cost - end_user_type_2$balancing_price
net_welfare_2 <- net_welfare_2 / point_data$pop_density / 100 / end_user_types_active$X2[1]

net_welfare_3 <- end_user_type_3$EOM_utility - end_user_type_3$EOM_cost - end_user_type_3$EOM_price
net_welfare_3 <- net_welfare_3 - end_user_type_3$EOM_supply / bat_eff^2 * wtp_user
net_welfare_3 <- net_welfare_3 + end_user_type_3$redispatch_utility + end_user_type_3$redispatch_reimbursement - end_user_type_3$redispatch_cost - end_user_type_3$redispatch_price
# net_welfare_3 <- net_welfare_3 + end_user_type_3$balancing_utility + end_user_type_3$balancing_reimbursement - end_user_type_3$balancing_cost - end_user_type_3$balancing_price
net_welfare_3 <- net_welfare_3 / point_data$pop_density / 100 / end_user_types_active$X3[1]

net_welfare_diff <- net_welfare_3 - net_welfare_0

net_welfare_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(net_welfare_Mat)){
  for(col_iter in 1:ncol(net_welfare_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      net_welfare_Mat[row_iter, col_iter] <- NA
    }else{
      net_welfare_Mat[row_iter, col_iter] <- net_welfare_diff[point_matrix[row_iter, col_iter]]
    }
  }
}
net_welfare_Mat <- t(net_welfare_Mat)

### Parameters for the field
w_min <- min(min(range(net_welfare_Mat,na.rm = T)), reference_gain[1])
w_max <- max(max(range(net_welfare_Mat,na.rm = T)), reference_gain[2])
w_extend <- seq(w_min, w_max, length.out = 10000)
cols_extend <- scales::col_numeric("YlOrRd", domain = NULL)(w_extend)
start_ID <- round((min(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
end_ID <- round((max(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
w_vals <- w_extend[start_ID:end_ID]
w_vals_norm <- unique(scales::rescale(c(w_vals)))
cols <- cols_extend[start_ID:end_ID]
colz <- setNames(data.frame(w_vals_norm, cols), NULL)

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = (net_welfare_Mat - min(net_welfare_diff))^(1/1), type = "heatmap",
  hoverinfo = 'none',
  showscale = F,
  colorscale = colz)

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "°",
               "\nlat: ", round(point_data$lat, 3), "°",
               "\n\nnet welfare difference:\n", round(net_welfare_diff, 3),
               " EUR", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Net Welfare Gain (EUR):", textposition = "top right", hoverinfo = 'none')
palette_level <- cols_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))]
net_welfare_level <- round(w_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))], 3)
for(level_iter in 1:length(net_welfare_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette_level[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = net_welfare_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot
```

#### July
```{r net welfare jul active, echo = FALSE, message = FALSE, warning = FALSE}

setwd(parent_dir)

scenario_name <- "active_end_user"
time_name <- "0701-0714"
dir_name <- paste(getwd(), "/data/output/", scenario_name, "/", time_name, "/agent/", sep = "")

file_name <- "end_user_type_0.csv"
end_user_type_0 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

file_name <- "end_user_type_2.csv"
end_user_type_2 <- read.csv(paste(dir_name, file_name, sep = ""), sep = "")

net_welfare_0 <- end_user_type_0$EOM_utility - end_user_type_0$EOM_cost - end_user_type_0$EOM_price
net_welfare_0 <- net_welfare_0 + end_user_type_0$redispatch_utility + end_user_type_0$redispatch_reimbursement - end_user_type_0$redispatch_cost - end_user_type_0$redispatch_price
# net_welfare_0 <- net_welfare_0 + end_user_type_0$balancing_utility + end_user_type_0$balancing_reimbursement - end_user_type_0$balancing_cost - end_user_type_0$balancing_price
net_welfare_0 <- net_welfare_0 / point_data$pop_density / 100 / end_user_types_active$X0[1]

net_welfare_2 <- end_user_type_2$EOM_utility - end_user_type_2$EOM_cost - end_user_type_2$EOM_price
net_welfare_2 <- net_welfare_2 + end_user_type_2$redispatch_utility + end_user_type_2$redispatch_reimbursement - end_user_type_2$redispatch_cost - end_user_type_2$redispatch_price
# net_welfare_2 <- net_welfare_2 + end_user_type_2$balancing_utility + end_user_type_2$balancing_reimbursement - end_user_type_2$balancing_cost - end_user_type_2$balancing_price
net_welfare_2 <- net_welfare_2 / point_data$pop_density / 100 / end_user_types_active$X2[1]

net_welfare_diff <- net_welfare_2 - net_welfare_0

net_welfare_Mat <- as.matrix(point_matrix)
for(row_iter in 1:nrow(net_welfare_Mat)){
  for(col_iter in 1:ncol(net_welfare_Mat)){
    if(point_matrix[row_iter, col_iter] == -1){
      net_welfare_Mat[row_iter, col_iter] <- NA
    }else{
      net_welfare_Mat[row_iter, col_iter] <- net_welfare_diff[point_matrix[row_iter, col_iter]]
    }
  }
}
net_welfare_Mat <- t(net_welfare_Mat)

### Parameters for the field
w_min <- min(min(range(net_welfare_Mat,na.rm = T)), reference_gain[1])
w_max <- max(max(range(net_welfare_Mat,na.rm = T)), reference_gain[2])
w_extend <- seq(w_min, w_max, length.out = 10000)
cols_extend <- scales::col_numeric("YlOrRd", domain = NULL)(w_extend)
start_ID <- round((min(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
end_ID <- round((max(range(net_welfare_Mat,na.rm = T)) - w_min) / (w_max - w_min) * length(w_extend))
w_vals <- w_extend[start_ID:end_ID]
w_vals_norm <- unique(scales::rescale(c(w_vals)))
cols <- cols_extend[start_ID:end_ID]
colz <- setNames(data.frame(w_vals_norm, cols), NULL)

NO_field_plot <- NO_power_system_plot %>%
  add_trace(x = seq(x_range_field [1], x_range_field [2], res_field),
  y = seq(y_range_field [1], y_range_field [2], res_field),
  z = (net_welfare_Mat - min(net_welfare_diff))^(1/1), type = "heatmap",
  hoverinfo = 'none',
  showscale = F,
  colorscale = colz)

NO_field_plot <- NO_field_plot %>%
  add_trace(x = point_data$x, y = point_data$y,
  type = 'scatter', mode = 'markers',
  marker = list(color = "black", size = 0),
  opacity = 0,
  text = paste("\nlon: ", round(point_data$lon, 3), "°",
               "\nlat: ", round(point_data$lat, 3), "°",
               "\n\nnet welfare difference:\n", round(net_welfare_diff, 3),
               " EUR", 
               sep = ""),
  hoverinfo = 'text'
  )

NO_field_plot <- NO_field_plot %>%
  add_text(x = node_data$x[132] + 150000, y = node_data$y[116] - 25000 + 100000 + 50000, 
  textfont = list(size = 18), text = "Net Welfare Gain (EUR):", textposition = "top right", hoverinfo = 'none')
palette_level <- cols_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))]
net_welfare_level <- round(w_extend[c(1, seq(.25, .75, .25) * length(w_extend), length(w_extend))], 3)
for(level_iter in 1:length(net_welfare_level)){
  NO_field_plot <- NO_field_plot %>%
    add_trace(x = node_data$x[132] + 50000 + 100000 * level_iter + 60000 * c(0: 1), y = rep(node_data$y[116] + 100000, 2),
    type = 'scatter', mode = 'lines', line = list(color = palette_level[level_iter], width = 10),
    hoverinfo = 'none'
    )
  NO_field_plot <- NO_field_plot %>%
    add_text(x = node_data$x[132] + 80000 + 100000 * level_iter, y = node_data$y[116] - 25000 + 100000,
    textfont = list(size = 14), text = net_welfare_level[level_iter], textposition = "bottom center", hoverinfo = 'none')
}

NO_field_plot
```